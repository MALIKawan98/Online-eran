<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdReach Rewards</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Toastify JS for Notifications -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .purple-gradient { background-image: linear-gradient(135deg, #A78BFA, #8B5CF6); }
        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; background-color: #e5e7eb; }
        @keyframes pulse { 50% { opacity: .5; } }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .ad-iframe { width: 100%; height: 150px; border: 1px solid #e5e7eb; border-radius: 1rem; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-lg"></div>

    <div id="svg-icons" class="hidden">
        <svg id="icon-profile" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
        <svg id="icon-coins" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 6v-1h4a2 2 0 012 2v10a2 2 0 01-2 2H8a2 2 0 01-2-2V8a2 2 0 012-2h4z" /></svg>
        <svg id="icon-tasks" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
        <svg id="icon-lifetime" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <svg id="icon-activities" xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" /></svg>
        <svg id="icon-arrow-right" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
        <svg id="icon-whatsapp" xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="currentColor" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
        <svg id="icon-email" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
        <svg id="icon-arrow-left" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
        <svg id="icon-dashboard" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
        <svg id="icon-admin-users" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        <svg id="icon-logout" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
        <svg id="icon-edit" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z" /></svg>
        <svg id="icon-delete" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
        <svg id="icon-block" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
        <svg id="icon-unblock" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <svg id="icon-check" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
        <svg id="icon-cross" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
    </div>

    <div id="modal-container"></div>
    
<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyB_lwJ61R9MZCnlEm_YKBrGyMit7HFNcMc", authDomain: "ff-zone-8869b.firebaseapp.com", databaseURL: "https://ff-zone-8869b-default-rtdb.firebaseio.com", projectId: "ff-zone-8869b", storageBucket: "ff-zone-8869b.appspot.com", messagingSenderId: "294255139459", appId: "1:294255139459:web:ffeaec1ecf75cfefc899b6" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    // --- GLOBAL CONSTANTS ---
    const AD_URL = "https://www.revenuecpmgate.com/jv36dh5sy?key=58d94fcbb7253d36f2aed5ea11e32fee";
    const WHATSAPP_NUMBER = "";
    const SUPPORT_EMAIL = "adeelawanmalikall@gmail.com";

    // --- HELPER FUNCTIONS ---
    const showToast = (message, isError = false) => Toastify({ text: message, duration: 3000, close: true, gravity: "top", position: "center", style: { background: isError ? "#ef4444" : "#8B5CF6", borderRadius: "1rem" } }).showToast();
    const getIcon = (id, classes = 'h-6 w-6') => {
        const icon = document.getElementById(id)?.cloneNode(true);
        if (icon) icon.setAttribute('class', classes);
        return icon?.outerHTML || '';
    };
    const getOrCreateUserId = () => {
        let userId = localStorage.getItem('adreachUserId');
        if (!userId) {
            userId = 'user_' + Date.now() + Math.random().toString(36).substring(2, 6);
            localStorage.setItem('adreachUserId', userId);
            db.ref('users/' + userId).set({ joined: new Date().toISOString(), balance: 0, tasksToday: 0, lifetimeTasks: 0, lastTaskDate: '', isBlocked: false, profile: { name: 'New User', phone: '' } });
        }
        return userId;
    };
    const showModal = (title, content, onSave) => {
        const modalId = 'modal-' + Date.now();
        const modalHTML = `<div id="${modalId}" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0"><div class="modal-content bg-white w-full max-w-md p-6 rounded-2xl shadow-xl transform scale-95"><h3 class="text-xl font-bold mb-4">${title}</h3><div>${content}</div><div class="flex justify-end space-x-3 mt-6"><button class="modal-cancel px-4 py-2 bg-slate-200 rounded-lg">Cancel</button><button class="modal-save px-4 py-2 bg-violet-500 text-white rounded-lg">Save</button></div></div></div>`;
        document.getElementById('modal-container').innerHTML = modalHTML;
        const modal = document.getElementById(modalId), modalContentEl = modal.querySelector('.modal-content');
        setTimeout(() => { modal.classList.remove('opacity-0'); modalContentEl.classList.remove('scale-95'); }, 10);
        const closeModal = () => { modal.classList.add('opacity-0'); modalContentEl.classList.add('scale-95'); setTimeout(() => modal.remove(), 300); };
        modal.querySelector('.modal-save').onclick = () => { onSave(); closeModal(); };
        modal.querySelector('.modal-cancel').onclick = closeModal;
    };

    // --- TEMPLATES (HTML Views) ---
    const AppShell = (content, showFooter = true) => `
        <div class="flex flex-col min-h-screen"><main class="flex-grow p-4 pb-24">${content}</main>
        ${showFooter ? `<footer class="fixed bottom-0 left-0 right-0 max-w-md mx-auto p-4 bg-white/80 backdrop-blur-sm border-t"><div class="flex items-center justify-between space-x-4"><a href="https://wa.me/${WHATSAPP_NUMBER}" target="_blank" class="flex-shrink-0 w-14 h-14 flex items-center justify-center bg-green-500 text-white rounded-full shadow-lg">${getIcon('icon-whatsapp', 'h-7 w-7')}</a><a href="#/withdrawal" class="flex-grow h-14 flex items-center justify-center px-6 bg-violet-500 text-white font-bold rounded-full shadow-lg text-lg">Withdraw Now</a><a href="mailto:${SUPPORT_EMAIL}" class="flex-shrink-0 w-14 h-14 flex items-center justify-center bg-violet-200 text-violet-600 rounded-full shadow-lg">${getIcon('icon-email', 'h-7 w-7')}</a></div></footer>` : ''}</div>`;
    
    const Header = (title, showProfile = true) => `<header class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold text-slate-800">${title}</h1>${showProfile ? `<a href="#/profile" class="p-2 rounded-full hover:bg-slate-100">${getIcon('icon-profile', 'h-8 w-8 text-slate-500')}</a>` : ''}</header>`;
    
    const BackHeader = (title) => `<header class="flex items-center mb-6"><a href="javascript:history.back()" class="p-2 -ml-2 mr-2 rounded-full hover:bg-slate-100">${getIcon('icon-arrow-left', 'h-7 w-7 text-slate-500')}</a><h1 class="text-2xl font-bold">${title}</h1></header>`;
    
    const DashboardPage = () => AppShell(`${Header('AdReach Rewards')}<div class="grid grid-cols-1 gap-4 mb-6"><div class="flex items-center space-x-4 p-4 bg-white rounded-2xl shadow-md"><div class="p-3 bg-violet-100 rounded-full">${getIcon('icon-coins')}</div><div><p class="text-sm text-slate-500">Current Balance</p><p id="current-balance" class="text-xl font-bold">0</p></div></div><div class="flex items-center space-x-4 p-4 bg-white rounded-2xl shadow-md"><div class="p-3 bg-violet-100 rounded-full">${getIcon('icon-tasks')}</div><div><p class="text-sm text-slate-500">Tasks Today</p><p id="tasks-today" class="text-xl font-bold">0</p></div></div><div class="flex items-center space-x-4 p-4 bg-white rounded-2xl shadow-md"><div class="p-3 bg-violet-100 rounded-full">${getIcon('icon-lifetime')}</div><div><p class="text-sm text-slate-500">Lifetime Tasks</p><p id="lifetime-tasks" class="text-xl font-bold">0</p></div></div></div><div class="grid grid-cols-2 gap-4 mb-6"><div class="p-4 bg-white rounded-2xl shadow-md">${getIcon('icon-activities', 'h-8 w-8 text-violet-500')}<p class="font-semibold mt-2">Recent Activities</p><p class="text-xs text-slate-400">Coming Soon</p></div><a href="#/earning" class="p-4 bg-violet-500 text-white rounded-2xl shadow-md"><div class="w-12 h-12 flex items-center justify-center bg-white/20 rounded-full mb-2">${getIcon('icon-arrow-right')}</div><p class="font-semibold text-lg">Today's Tasks</p><p class="text-xs">Start earning now!</p></a></div><div class="purple-gradient text-white p-6 rounded-2xl shadow-lg text-center"><p class="text-lg opacity-80">Total Lifetime Earnings</p><p id="lifetime-earnings" class="text-4xl font-extrabold mt-2">0 Coins</p></div>`);
    
    const EarningPage = () => AppShell(`${BackHeader('Available Tasks')}<div id="tasks-loader" class="space-y-4">${[...Array(3)].map(() => `<div class="p-4 bg-white rounded-2xl shadow-md skeleton h-20"></div>`).join('')}</div><div id="tasks-container" class="space-y-4"></div>`, false);
    
    const ProfilePage = () => AppShell(`${BackHeader('My Profile')}<div class="p-6 bg-white rounded-2xl shadow-md"><form id="profile-form" class="space-y-4"><div><label for="profile-name" class="block text-sm font-medium mb-1">Full Name</label><input type="text" id="profile-name" class="w-full px-4 py-2 border rounded-lg" required></div><div><label for="profile-phone" class="block text-sm font-medium mb-1">Phone Number</label><input type="tel" id="profile-phone" class="w-full px-4 py-2 border rounded-lg" required></div><div><label class="block text-sm font-medium mb-1">Your User ID</label><input type="text" id="user-id" class="w-full px-4 py-2 bg-slate-100 border rounded-lg" readonly></div><button type="submit" class="w-full h-12 bg-violet-500 text-white font-bold rounded-lg shadow-lg">Save Changes</button></form></div><div class="mt-8 text-center"><a href="#/admin/login" class="text-sm text-slate-400 hover:text-violet-500">Admin Panel Access</a></div>`, false);
    
    const WithdrawalPage = () => AppShell(`<div class="flex justify-between items-center mb-6"><h1 class="text-2xl font-bold text-slate-800">Withdraw Funds</h1><a href="#/history" class="text-sm font-semibold text-violet-500 hover:text-violet-700">View History</a></div><div class="p-6 bg-white rounded-2xl shadow-md"><div class="text-center mb-6"><p class="text-slate-500">Your Balance (1 Coin = 1 PKR)</p><p id="withdrawal-balance" class="text-4xl font-bold text-violet-500"><span class="h-10 w-32 inline-block skeleton rounded"></span></p></div><form id="withdrawal-form" class="space-y-4"><div><label class="block text-sm font-medium mb-1">Amount (Min: 1000)</label><input type="number" id="withdraw-amount" min="1000" class="w-full p-2 border rounded-lg" required></div><div><label class="block text-sm font-medium mb-1">Account Number</label><input type="text" id="withdraw-account" placeholder="e.g., 03001234567" class="w-full p-2 border rounded-lg" required></div><div><label class="block text-sm font-medium mb-1">Payment Method</label><select id="withdraw-method" class="w-full p-2 border rounded-lg"><option>EasyPaisa</option><option>JazzCash</option></select></div><div><label class="block text-sm font-medium mb-1">Account Holder Name</label><input type="text" id="withdraw-name" placeholder="Enter your account name" class="w-full p-2 border rounded-lg" required></div><button type="submit" class="w-full h-12 bg-violet-500 text-white font-bold rounded-lg shadow-lg">Submit Request</button></form></div>`, false);

    const HistoryPage = () => AppShell(`${BackHeader('Withdrawal History')}<div id="history-loader" class="space-y-4">${[...Array(3)].map(() => `<div class="p-4 bg-white rounded-2xl shadow-md skeleton h-24"></div>`).join('')}</div><div id="history-container" class="space-y-3"></div>`, false);
    
    const AdFramePage = () => `<div class="flex flex-col h-screen p-4 bg-slate-800 text-white"><div class="text-center py-4"><p class="text-lg">Please watch the ads</p><h1 id="ad-timer" class="text-5xl font-bold my-2">30</h1><p>seconds remaining</p></div><div id="ad-frames-container" class="flex-grow space-y-3 overflow-y-auto">${[...Array(3)].map(() => `<iframe src="${AD_URL}" class="ad-iframe"></iframe>`).join('')}</div><div class="pt-4"><button id="claim-button" class="hidden w-full h-14 bg-green-500 text-white font-bold rounded-lg shadow-lg text-lg">Claim Reward & Visit Link</button></div></div>`;
    
    const AdminLoginPage = () => `<div class="flex flex-col items-center justify-center min-h-screen p-4 bg-slate-100"><div class="w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-xl"><div class="text-center"><h1 class="text-3xl font-bold text-violet-600">Admin Panel</h1></div><form id="admin-login-form" class="space-y-4"><div><label class="text-sm">Username</label><input id="admin-user" type="text" required class="w-full mt-1 p-2 border rounded-lg" placeholder="Username"></div><div><label class="text-sm">Password</label><input id="admin-pass" type="password" required class="w-full mt-1 p-2 border rounded-lg" placeholder="Password"></div><button type="submit" class="w-full h-12 bg-violet-500 text-white font-bold rounded-lg shadow-lg">Login</button></form></div></div>`;
    
    const AdminShell = (title, content) => {
        const path = window.location.hash.substring(1) || '/';
        const navItemClass = "flex-1 flex flex-col items-center justify-center p-2 rounded-lg font-semibold transition-colors";
        const activeClass = "bg-violet-500 text-white shadow", inactiveClass = "text-slate-500 hover:bg-violet-100";
        return `<div class="flex flex-col min-h-screen bg-slate-100 pb-20"><header class="bg-white p-4 shadow-md flex justify-between items-center sticky top-0 z-10"><h1 class="text-xl font-bold text-violet-600">Admin</h1><button onclick="sessionStorage.removeItem('adminAuthed'); router.navigate('/');" class="p-2 text-slate-500 rounded-full">${getIcon('icon-logout')}</button></header><main class="flex-grow p-4"><h2 class="text-3xl font-bold mb-6">${title}</h2>${content}</main><nav class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white/90 backdrop-blur-sm border-t p-2 flex justify-around space-x-2"><a href="#/admin/dashboard" class="${navItemClass} ${path.includes('dashboard') ? activeClass : inactiveClass}">${getIcon('icon-dashboard')}<span class="text-xs mt-1">Dash</span></a><a href="#/admin/users" class="${navItemClass} ${path.includes('users') ? activeClass : inactiveClass}">${getIcon('icon-admin-users')}<span class="text-xs mt-1">Users</span></a><a href="#/admin/tasks" class="${navItemClass} ${path.includes('tasks') ? activeClass : inactiveClass}">${getIcon('icon-tasks')}<span class="text-xs mt-1">Tasks</span></a><a href="#/admin/withdrawals" class="${navItemClass} ${path.includes('withdrawals') ? activeClass : inactiveClass}">${getIcon('icon-coins')}<span class="text-xs mt-1">Withdraw</span></a></nav></div>`;
    };

    const AdminDashboardPage = () => AdminShell('Dashboard', `<div id="admin-stats" class="grid grid-cols-2 gap-4"></div>`);
    const AdminTasksPage = () => AdminShell('Task Management', `<div class="text-right mb-4"><button id="add-task-btn" class="px-5 py-2 bg-violet-500 text-white font-bold rounded-lg shadow-lg">Add New Task</button></div><div id="tasks-list" class="bg-white rounded-2xl shadow-md overflow-hidden"></div>`);
    const AdminUsersPage = () => AdminShell('User Management', `<div class="mb-4"><input type="search" id="user-search" placeholder="Search by User ID..." class="w-full p-3 border rounded-lg"></div><div id="users-list" class="bg-white rounded-2xl shadow-md overflow-hidden"></div>`);
    const AdminWithdrawalsPage = () => AdminShell('Withdrawal Requests', `<div id="withdrawals-list" class="bg-white rounded-2xl shadow-md overflow-hidden"></div>`);

    // --- ROUTER ---
    const router = {
        routes: {
            '/': { template: DashboardPage, loader: loadDashboardData }, '/earning': { template: EarningPage, loader: loadEarningData }, '/withdrawal': { template: WithdrawalPage, loader: loadWithdrawalData }, '/profile': { template: ProfilePage, loader: loadProfileData }, '/history': { template: HistoryPage, loader: loadHistoryData }, '/ad-frame': { template: AdFramePage, loader: loadAdFrameData }, '/admin/login': { template: AdminLoginPage, loader: handleAdminLoginPageSetup }, '/admin/dashboard': { template: AdminDashboardPage, loader: loadAdminDashboardData, admin: true }, '/admin/tasks': { template: AdminTasksPage, loader: loadAdminTasksData, admin: true }, '/admin/users': { template: AdminUsersPage, loader: loadAdminUsersData, admin: true }, '/admin/withdrawals': { template: AdminWithdrawalsPage, loader: loadAdminWithdrawalsData, admin: true },
        },
        appContainer: document.getElementById('app'),
        navigate(path) { window.location.hash = path; },
        render() {
            let path = window.location.hash.substring(1) || '/';
            let routeKey = path.split('?')[0];
            if(routeKey.startsWith('/ad-frame')) { routeKey = '/ad-frame'; }
            const route = this.routes[routeKey];
            if (route) {
                if (route.admin && !sessionStorage.getItem('adminAuthed')) { this.navigate('/admin/login'); return; }
                this.appContainer.innerHTML = route.template();
                if (route.loader) route.loader(path);
            } else { this.appContainer.innerHTML = `<div class="p-8 text-center"><h1 class="text-2xl font-bold">404 Not Found</h1><a href="#" class="text-violet-500">Go Home</a></div>`; }
        },
        init() { window.addEventListener('hashchange', this.render.bind(this)); this.render(); }
    };
    
    // --- DATA LOADERS & HANDLERS ---
    
    async function loadDashboardData() {
        const userId = getOrCreateUserId();
        db.ref('users/' + userId).on('value', (snapshot) => {
            const data = snapshot.val(); if (!data) return;
            if (data.isBlocked) { document.body.innerHTML = `<div class="fixed inset-0 flex items-center justify-center text-center p-4 bg-white"><div><h1 class="text-2xl font-bold text-red-600">Account Blocked</h1><p class="text-slate-600">Your account has been blocked.</p></div></div>`; return; }
            const today = new Date().toISOString().split('T')[0];
            if (data.lastTaskDate !== today) { db.ref('users/' + userId).update({ tasksToday: 0 }); }
            document.getElementById('current-balance').textContent = data.balance || 0;
            document.getElementById('tasks-today').textContent = data.tasksToday || 0;
            document.getElementById('lifetime-tasks').textContent = data.lifetimeTasks || 0;
            document.getElementById('lifetime-earnings').textContent = `${data.balance || 0} Coins`;
        });
    }

    async function loadEarningData() {
        db.ref('tasks').on('value', (snapshot) => {
            const tasks = snapshot.val();
            document.getElementById('tasks-loader').style.display = 'none';
            const container = document.getElementById('tasks-container'); container.innerHTML = '';
            if (!tasks) { container.innerHTML = `<p class="text-center text-slate-500">No tasks available.</p>`; return; }
            Object.keys(tasks).forEach(key => {
                const task = tasks[key];
                container.innerHTML += `<div class="flex items-center justify-between p-4 bg-white rounded-2xl shadow-md"><div><h3 class="font-bold text-lg">${task.title}</h3><p class="text-sm text-green-500 font-semibold">+${task.reward} Coins</p></div><button onclick="handleTaskClick('${key}', ${task.reward})" class="px-6 py-2 bg-violet-500 text-white font-bold rounded-full shadow-lg">View Ad</button></div>`;
            });
        });
    }

    function handleTaskClick(taskId, reward) {
        router.navigate(`/ad-frame?taskId=${taskId}&reward=${reward}`);
    }
    
    function loadAdFrameData(path) {
        const params = new URLSearchParams(path.split('?')[1]);
        const taskId = params.get('taskId');
        const reward = parseInt(params.get('reward'), 10);
        if (!taskId || !reward) { showToast("Invalid task link.", true); router.navigate('/earning'); return; }
        let timeLeft = 30;
        const timerEl = document.getElementById('ad-timer');
        const claimBtn = document.getElementById('claim-button');
        const timerInterval = setInterval(() => {
            timeLeft--;
            timerEl.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                timerEl.parentElement.innerHTML = '<h1 class="text-3xl font-bold py-2">Timer Complete!</h1><p>You can now claim your reward.</p>';
                claimBtn.classList.remove('hidden');
            }
        }, 1000);
        claimBtn.onclick = () => {
            claimBtn.disabled = true;
            claimBtn.textContent = 'Processing...';
            handleRewardClaim(taskId, reward);
        };
    }
    
    async function handleRewardClaim(taskId, reward) {
        window.open(AD_URL, '_blank');
        const userId = getOrCreateUserId();
        const userRef = db.ref('users/' + userId);
        const today = new Date().toISOString().split('T')[0];
        userRef.transaction((data) => {
            if (data) {
                data.balance = (data.balance || 0) + reward;
                data.tasksToday = ((data.lastTaskDate === today) ? data.tasksToday : 0) + 1;
                data.lifetimeTasks = (data.lifetimeTasks || 0) + 1;
                data.lastTaskDate = today;
            } return data;
        }, (error, committed) => {
            if (committed) showToast(`Congratulations! +${reward} coins added.`);
            else showToast("Error saving task.", true);
            router.navigate('/');
        });
    }

    async function loadProfileData() {
        const userId = getOrCreateUserId();
        document.getElementById('user-id').value = userId;
        db.ref('users/' + userId + '/profile').once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) { document.getElementById('profile-name').value = data.name || ''; document.getElementById('profile-phone').value = data.phone || ''; }
        });
        document.getElementById('profile-form').onsubmit = (e) => {
            e.preventDefault();
            db.ref('users/' + userId + '/profile').update({ name: document.getElementById('profile-name').value, phone: document.getElementById('profile-phone').value }).then(() => showToast("Profile updated!"));
        };
    }
    
    async function loadWithdrawalData() {
        const userId = getOrCreateUserId();
        const userRef = db.ref('users/' + userId);
        userRef.once('value', (snapshot) => {
            const data = snapshot.val();
            document.getElementById('withdrawal-balance').textContent = `${data.balance || 0} Coins`;
            if (data.profile?.phone) document.getElementById('withdraw-account').value = data.profile.phone;
            if (data.profile?.name) document.getElementById('withdraw-name').value = data.profile.name;
        });
        document.getElementById('withdrawal-form').onsubmit = async (e) => {
            e.preventDefault();
            const amount = parseInt(document.getElementById('withdraw-amount').value, 10);
            const account = document.getElementById('withdraw-account').value;
            const method = document.getElementById('withdraw-method').value;
            const name = document.getElementById('withdraw-name').value;
            const balanceSnapshot = await userRef.child('balance').once('value');
            const currentBalance = balanceSnapshot.val() || 0;
            if (amount < 1000) { showToast("Minimum withdrawal is 1000 coins.", true); return; }
            if (amount > currentBalance) { showToast("Insufficient balance.", true); return; }
            db.ref('withdrawals').push().set({ userId, amount, account, method, name, status: 'pending', timestamp: firebase.database.ServerValue.TIMESTAMP });
            userRef.update({ balance: currentBalance - amount });
            showToast("Withdrawal request submitted!");
            router.navigate('/');
        };
    }

    async function loadHistoryData() {
        const userId = getOrCreateUserId();
        const historyContainer = document.getElementById('history-container');
        const loader = document.getElementById('history-loader');
        const historyRef = db.ref('withdrawals').orderByChild('userId').equalTo(userId);
        historyRef.on('value', (snapshot) => {
            loader.style.display = 'none';
            historyContainer.innerHTML = '';
            const historyData = snapshot.val();
            if (!historyData) {
                historyContainer.innerHTML = `<p class="text-center text-slate-500 p-8">You have no withdrawal history.</p>`;
                return;
            }
            const sortedHistory = Object.values(historyData).sort((a, b) => b.timestamp - a.timestamp);
            sortedHistory.forEach(record => {
                const date = new Date(record.timestamp).toLocaleString();
                const statusColors = { pending: 'yellow', paid: 'green', rejected: 'red' };
                const statusColor = statusColors[record.status] || 'gray';
                const statusBadge = `<span class="text-xs font-semibold px-2 py-1 bg-${statusColor}-100 text-${statusColor}-800 rounded-full capitalize">${record.status}</span>`;
                historyContainer.innerHTML += `<div class="p-4 bg-white rounded-2xl shadow-md border-l-4 border-${statusColor}-500"><div class="flex justify-between items-start"><div><p class="font-bold text-xl text-slate-800">${record.amount} Coins</p><p class="text-sm text-slate-600">${record.method}: ${record.account}</p><p class="text-xs text-slate-400 mt-1">${date}</p></div>${statusBadge}</div></div>`;
            });
        });
    }

    function handleAdminLoginPageSetup() {
        const form = document.getElementById('admin-login-form');
        if (form) {
            form.onsubmit = (e) => {
                e.preventDefault();
                const user = document.getElementById('admin-user').value;
                const pass = document.getElementById('admin-pass').value;
                if (user === 'Admin666' && pass === 'hack99') {
                    sessionStorage.setItem('adminAuthed', 'true');
                    showToast("Login successful!");
                    router.navigate('/admin/dashboard');
                } else {
                    showToast("Invalid credentials.", true);
                }
            };
        }
    }
    
    function loadAdminDashboardData() {
        const statsContainer = document.getElementById('admin-stats');
        statsContainer.innerHTML = `<div class="p-4 bg-white rounded-2xl shadow-md skeleton h-24"></div>`.repeat(4);
        db.ref().on('value', snapshot => {
            const data = snapshot.val() || {};
            const users = data.users ? Object.values(data.users) : [];
            const withdrawals = data.withdrawals ? Object.values(data.withdrawals) : [];
            statsContainer.innerHTML = `<div class="p-5 bg-white rounded-2xl shadow-md"><p class="text-slate-500 text-sm">Total Users</p><p class="text-3xl font-bold">${users.length}</p></div><div class="p-5 bg-white rounded-2xl shadow-md"><p class="text-slate-500 text-sm">Active Tasks</p><p class="text-3xl font-bold">${data.tasks ? Object.keys(data.tasks).length : 0}</p></div><div class="p-5 bg-white rounded-2xl shadow-md"><p class="text-slate-500 text-sm">Pending</p><p class="text-3xl font-bold">${withdrawals.filter(w=>w.status==='pending').length}</p></div><div class="p-5 bg-white rounded-2xl shadow-md"><p class="text-slate-500 text-sm">Total Coins</p><p class="text-3xl font-bold">${users.reduce((s,u)=>s+(u.balance||0),0)}</p></div>`;
        });
    }

    function loadAdminTasksData() {
        const listEl = document.getElementById('tasks-list');
        document.getElementById('add-task-btn').onclick = () => handleEditTask();
        db.ref('tasks').on('value', snapshot => {
            const tasks = snapshot.val() || {};
            listEl.innerHTML = Object.keys(tasks).length === 0 ? `<p class="p-4 text-center">No tasks.</p>` : `<table class="w-full text-left"><thead><tr class="border-b"><th class="p-3 text-sm">Title</th><th class="p-3 text-sm">Reward</th><th class="p-3 text-sm">Actions</th></tr></thead><tbody>${Object.entries(tasks).map(([key, task]) => `<tr class="border-b last:border-b-0"><td class="p-3 font-semibold">${task.title}</td><td class="p-3">${task.reward}</td><td class="p-3 flex space-x-2"><button onclick="handleEditTask('${key}', '${task.title}', ${task.reward})" class="p-2 text-blue-500 rounded-full">${getIcon('icon-edit', 'h-5 w-5')}</button><button onclick="handleDeleteTask('${key}')" class="p-2 text-red-500 rounded-full">${getIcon('icon-delete', 'h-5 w-5')}</button></td></tr>`).join('')}</tbody></table>`;
        });
    }

    function handleEditTask(taskId = null, title = '', reward = '') {
        showModal(taskId ? 'Edit Task' : 'Create Task', `<div><label>Title</label><input id="task-title" type="text" value="${title}" class="w-full p-2 border rounded-lg"></div><div class="mt-4"><label>Reward</label><input id="task-reward" type="number" value="${reward}" class="w-full p-2 border rounded-lg"></div>`, () => {
            const newTitle = document.getElementById('task-title').value;
            const newReward = parseInt(document.getElementById('task-reward').value, 10);
            if (!newTitle || !newReward) return showToast('All fields required.', true);
            const ref = taskId ? db.ref('tasks/' + taskId) : db.ref('tasks').push();
            ref.set({ title: newTitle, reward: newReward }).then(() => showToast(`Task saved!`));
        });
    }

    function handleDeleteTask(taskId) { if (confirm('Delete this task?')) { db.ref('tasks/' + taskId).remove().then(() => showToast('Task deleted.')); } }
    
    function loadAdminUsersData() {
        const listEl = document.getElementById('users-list');
        const searchInput = document.getElementById('user-search');
        let allUsers = {};
        const renderUsers = (filter = '') => {
            const filteredUsers = Object.entries(allUsers).filter(([id]) => id.includes(filter.toLowerCase()));
            listEl.innerHTML = filteredUsers.length === 0 ? `<p class="p-4 text-center">No users.</p>` : `<table class="w-full text-left"><thead><tr class="border-b"><th class="p-3 text-sm">User ID</th><th class="p-3 text-sm">Balance</th><th class="p-3 text-sm">Actions</th></tr></thead><tbody>${filteredUsers.map(([id, user]) => `<tr class="border-b ${user.isBlocked ? 'bg-red-50' : ''}"><td class="p-3 text-xs font-mono">${id.substring(0,15)}...</td><td class="p-3 font-semibold">${user.balance||0}</td><td class="p-3 flex space-x-1"><button onclick="handleEditUserCoins('${id}', ${user.balance||0})" class="p-2 text-blue-500 rounded-full">${getIcon('icon-edit', 'h-5 w-5')}</button><button onclick="db.ref('users/${id}/isBlocked').set(!${!!user.isBlocked})">${user.isBlocked ? getIcon('icon-unblock','h-5 w-5 text-green-600') : getIcon('icon-block','h-5 w-5 text-red-600')}</button></td></tr>`).join('')}</tbody></table>`;
        };
        searchInput.oninput = (e) => renderUsers(e.target.value);
        db.ref('users').on('value', snapshot => { allUsers = snapshot.val() || {}; renderUsers(searchInput.value); });
    }

    function handleEditUserCoins(userId, balance) {
        showModal('Adjust Coins', `<div><label>New Balance</label><input id="user-balance" type="number" value="${balance}" class="w-full p-2 border rounded-lg"></div>`, () => {
            const newBalance = parseInt(document.getElementById('user-balance').value, 10);
            if (isNaN(newBalance) || newBalance < 0) return showToast('Invalid balance.', true);
            db.ref(`users/${userId}/balance`).set(newBalance).then(() => showToast('Balance updated!'));
        });
    }
    
    function loadAdminWithdrawalsData() {
        const listEl = document.getElementById('withdrawals-list');
        db.ref('withdrawals').orderByChild('status').equalTo('pending').on('value', snapshot => {
            const requests = snapshot.val() || {};
            listEl.innerHTML = Object.keys(requests).length === 0 ? `<p class="p-4 text-center">No pending requests.</p>` : `<div class="space-y-3 p-2">${Object.entries(requests).map(([id, req]) => `<div class="p-4 rounded-lg border"><p class="font-bold text-xl text-violet-600">${req.amount} Coins</p><p class="font-semibold">${req.name}</p><p class="text-sm">${req.method}: ${req.account}</p><p class="text-xs font-mono text-slate-400">${req.userId}</p><div class="flex justify-end space-x-2 mt-2"><button onclick="handleWithdrawalAction('${id}', '${req.userId}', ${req.amount}, 'rejected')" class="px-3 py-1 text-sm bg-red-100 text-red-700 rounded-lg">${getIcon('icon-cross','h-4 w-4 inline')} Reject</button><button onclick="handleWithdrawalAction('${id}', null, null, 'paid')" class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded-lg">${getIcon('icon-check','h-4 w-4 inline')} Mark Paid</button></div></div>`).join('')}</div>`;
        });
    }

    function handleWithdrawalAction(reqId, userId, amount, newStatus) {
        if (newStatus === 'paid') {
            db.ref(`withdrawals/${reqId}`).update({ status: 'paid' }).then(() => showToast('Marked as paid!'));
        } else if (newStatus === 'rejected') {
            db.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) + amount)
            .then(() => db.ref(`withdrawals/${reqId}`).update({ status: 'rejected' }).then(() => showToast('Rejected and refunded.')));
        }
    }

    // --- INITIALIZE THE APP ---
    document.addEventListener('DOMContentLoaded', () => router.init());
</script>
</body>
</html>
